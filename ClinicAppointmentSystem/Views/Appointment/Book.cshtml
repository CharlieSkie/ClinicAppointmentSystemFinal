@{
    ViewData["Title"] = "Book Appointment";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="fas fa-calendar-plus"></i> Book Appointment</h1>
        <a asp-controller="Client" asp-action="Dashboard" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Appointment Details</h5>
                </div>
                <div class="card-body">
                    <!-- SIMPLE HTML FORM -->
                    <form method="post" action="/Appointment/Book">
                        @Html.AntiForgeryToken()

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="control-label">Doctor *</label>
                                    <select name="doctorId" class="form-control" id="DoctorId" required>
                                        <option value="">Select Doctor</option>
                                        @foreach (var doctor in ViewBag.Doctors)
                                        {
                                            <option value="@doctor.Id">@doctor.Name - @doctor.Specialization</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="control-label">Appointment Date *</label>
                                    <input name="appointmentDate" type="date" class="form-control" id="AppointmentDate"
                                           min="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="control-label">Start Time *</label>
                                    <select name="startTime" class="form-control" id="StartTime" required>
                                        <option value="">Select Time</option>
                                        <!-- Time slots will be populated by JavaScript -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="control-label">End Time</label>
                                    <input type="time" class="form-control" id="EndTime" readonly />
                                    <input type="hidden" name="endTime" id="HiddenEndTime" />
                                    <small class="form-text text-muted">End time is calculated automatically (30-minute appointments)</small>
                                </div>
                            </div>
                        </div>

                        <!-- Service ID is required but we'll set a default value -->
                        <input type="hidden" name="serviceId" value="1" />

                        <div class="form-group mb-3">
                            <label class="control-label">Notes (Optional)</label>
                            <textarea name="notes" class="form-control" rows="3" placeholder="Any special notes or requirements..."></textarea>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-calendar-check"></i> Book Appointment
                            </button>
                            <a asp-controller="Client" asp-action="Dashboard" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Booking Guidelines</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <i class="fas fa-info-circle text-primary"></i>
                            Only one appointment per day allowed
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-clock text-warning"></i>
                            Book at least 24 hours in advance
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-calendar-times text-danger"></i>
                            Cancel at least 2 hours before appointment
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-user-md text-success"></i>
                            Doctor availability varies by day
                        </li>
                    </ul>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title">Available Time Slots</h5>
                </div>
                <div class="card-body">
                    <div id="timeSlotsContainer">
                        <p class="text-muted">Select a doctor and date to see available time slots.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const doctorSelect = document.getElementById('DoctorId');
            const dateInput = document.getElementById('AppointmentDate');
            const startTimeSelect = document.getElementById('StartTime');
            const endTimeInput = document.getElementById('EndTime');
            const hiddenEndTime = document.getElementById('HiddenEndTime');
            const timeSlotsContainer = document.getElementById('timeSlotsContainer');

            // Load time slots when doctor or date changes
            doctorSelect.addEventListener('change', loadTimeSlots);
            dateInput.addEventListener('change', loadTimeSlots);

            // Update end time when start time changes
            startTimeSelect.addEventListener('change', updateEndTime);

            async function loadTimeSlots() {
                const doctorId = doctorSelect.value;
                const date = dateInput.value;

                if (doctorId && date) {
                    timeSlotsContainer.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Loading available time slots...';

                    try {
                        const response = await fetch(`/Appointment/GetAvailableTimeSlots?doctorId=${doctorId}&date=${date}`);
                        const data = await response.json();

                        startTimeSelect.innerHTML = '<option value="">Select Time</option>';

                        if (data.length > 0) {
                            data.forEach(time => {
                                const timeString = time.substring(0, 5); // Format as HH:mm
                                const option = document.createElement('option');
                                option.value = timeString;
                                option.textContent = timeString;
                                startTimeSelect.appendChild(option);
                            });
                            timeSlotsContainer.innerHTML = `<p class="text-success"><i class="fas fa-check-circle"></i> ${data.length} time slots available</p>`;
                        } else {
                            timeSlotsContainer.innerHTML = '<p class="text-danger"><i class="fas fa-exclamation-circle"></i> No available time slots for selected date</p>';
                        }
                    } catch (error) {
                        timeSlotsContainer.innerHTML = '<p class="text-danger"><i class="fas fa-exclamation-circle"></i> Error loading time slots</p>';
                        console.error('Error loading time slots:', error);
                    }
                } else {
                    timeSlotsContainer.innerHTML = '<p class="text-muted">Select a doctor and date to see available time slots.</p>';
                }
            }

            function updateEndTime() {
                const startTime = startTimeSelect.value;
                if (startTime) {
                    // Calculate end time (30 minutes later)
                    const start = new Date('1970-01-01T' + startTime + 'Z');
                    const end = new Date(start.getTime() + 30 * 60000); // 30 minutes
                    const endTimeString = end.toTimeString().substring(0, 5);
                    endTimeInput.value = endTimeString;
                    hiddenEndTime.value = endTimeString;
                } else {
                    endTimeInput.value = '';
                    hiddenEndTime.value = '';
                }
            }
        });
    </script>
}